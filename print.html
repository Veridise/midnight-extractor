<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Midnight extractor user manual</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-eb7e533e.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-6ee936f5.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Midnight extractor user manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>The extraction tool needs to be built from source. This is because the harness definitions depend on
the <code>circuits</code> crate in <a href="https://github.com/midnightntwrk/midnight-zk">midnight-zk</a>.</p>
<p>TODO: How to obtain the source distro.</p>
<p>Once inside of the directory where the source is located you can build and run the tool.</p>
<p>First, verify that the version of <code>midnight-circuits</code> that the tool is linked against
is the version you are interesting in extracting from.</p>
<p>Check that the dependency is pointing to the right repository and the right revision.
Also make sure that it has the <code>extraction</code> feature enabled. Without this feature the
circuits do not include the necessary integrations.</p>
<p>For example:</p>
<pre><code>$ cargo info midnight-circuits
midnight-circuits
version: 5.0.1 (from https://github.com/Veridise/midnight-zk#0d63a4d4)
license: unknown
rust-version: unknown
features:
 +default              = []
  bench-internal       = [midnight-proofs/bench-internal]
  extraction           = [extractor-support, testing, midnight-proofs/extraction, picus/extractor-derive]
  extractor-support    = [dep:extractor-support]
  heap_profiling       = []
  serde                = [dep:serde]
  serde_derive         = [dep:serde_derive]
  serde_json           = [dep:serde_json]
  testing              = [num-bigint/rand]
  truncated-challenges = [midnight-proofs/truncated-challenges]
</code></pre>
<p>Once everything looks good you can build the tool as usual with <code>cargo build --release</code>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="extraction"><a class="header" href="#extraction">Extraction</a></h1>
<p>Once the tool is build you can use the <code>midnight-extractor</code> CLI to extract the circuits.</p>
<h2 id="quickstart"><a class="header" href="#quickstart">Quickstart</a></h2>
<p>To extract all the circuits you can use the <code>extract-all.sh</code> script located in the <code>scripts</code> directory.
The Picus representation of the extracted circuits can be found in the <code>picus_files</code> directory.
By default this tool does not extract the LLZK versions.</p>
<h2 id="cli-usage"><a class="header" href="#cli-usage">CLI usage</a></h2>
<p>The <code>midnight-extractor</code> CLI builds a list of extractable circuits at runtime then extracts them to the desired format.
The CLI has a series of flags and arguments that allows controlling the selection of circuits to extract. The CLI also has
flags for controlling the output produced by the tool.</p>
<p>Use the <code>--help</code> flag to see the full list of options.</p>
<h3 id="circuit-selection"><a class="header" href="#circuit-selection">Circuit selection</a></h3>
<p>Each circuit has 4 properties that are used for filtering and selection; <em>instruction</em>, <em>chip</em>, <em>type</em>, and <em>name</em>.</p>
<p>The <em>instruction</em> groups together circuits that are related and in general corresponds to an instruction-like trait
(i.e. <code>arithmetic</code> corresponds to <code>ArithInstructions</code> or <code>ecc</code> to <code>EccInstructions</code>). The instructions are selected as
positional arguments. Adding instructions to the CLI invocation creates a set of selected instructions. If no
instructions are passed to the CLI then all instructions are considered.</p>
<p>Possible <em>instruction</em> values: <code>arithmetic, assertion, assignment, automaton, base64, base64-var, biguint, binary, bitwise, canonicity, committed-instance, comparison, control-flow, conversion, core-decomposition, decomposition, division, ecc, equality, field, foreign-ecc, hash, hash-to-curve, map, map-to-curve, parser, pow2-range, public-input, range-check, sha256, sponge, stdlib, unsafe-conversion, varhash, vector, zero</code>.</p>
<p>The <em>chip</em> declares what concrete implementation of the <em>instruction</em> is used by the circuit. Different chips
implement the same instruction traits and this parameter allows configuring what chip is going to be targeted.
To select a chip use the <code>--chip &lt;name&gt;</code> flag. This will make the tool filter out any circuit that is not implemented
by the chip. If the flag is not passed then the tool will consider all chips.</p>
<p>Possible <em>chip</em> values: <code>native, native-gadget, field, poseidon, pow2-range, p2r-decomposition, sha256, ecc, foreign-ecc-native, foreign-ecc-field, vector, biguint, stdlib, automaton, base64, hash-to-curve, map, parser, varlen-poseidon, varlen-sha256</code>.</p>
<p>The <em>type</em> declares what high-level type the circuit is using and can be selected with the <code>--type &lt;name&gt;</code> flag.
Similarly to <code>--chip</code>, not passing this flag makes the tool consider all types. The circuits distinguish by type
because some circuits implement the same instructions for multiple. For example, the <code>native</code> chip implements
the <code>equality</code> instructions for the <code>native</code> and <code>bit</code> types.</p>
<p>Possible <em>type</em> values: <code>native, bit, field, byte, biguint, scalar, point</code>.</p>
<p>The <em>name</em> describes the functionality the circuit is trying to represent. In general corresponds to methods in
one of the instruction-like traits. Some methods have a variable number of arguments. In cases like that
then multiple circuits may be created with different combinations of arguments and the <em>name</em> will contain information
about the combination (i.e. the circuits <code>hash/hash_1/sha256/byte</code> and <code>hash/hash_10/sha256/byte</code> operate on 1 and 10
input values respectively).</p>
<p>You can filter by name with both a whitelist and a blacklist. If the whitelist is passed,
any circuit outside of the list is discarded. And, if the blacklist is passed, then any circuit inside it is discarded.
If the whitelist or the blacklist are not set then they have no effect and all circuit names will be included in the
extraction. Both lists can be configured as a comma separated list passed as arguments to the <code>--method-whitelist</code> and
<code>--method-blacklist</code> flags.</p>
<p>You can combine these flags in any way you want. You can also pass the <code>--list</code> flag to the tool makes it print the
selected circuits instead of extracting them. This is useful for debugging a circuit selection that is not producing the
desired results.</p>
<h3 id="constants"><a class="header" href="#constants">Constants</a></h3>
<p>Some harnesses require a list of literal values that will be used as compile-time constants representing
off-circuit values in the harness’ input. To pass constants use either <code>--constants</code> or <code>--constants-file</code>.
The former expects a comma separated list of literal values. All types expect their decimal representation with the
exception of <code>bit</code> with expectes either <code>true</code> or <code>false</code>. The latter expects a path to a file containing lines
of comma separated values. These values have the same requirements as the <code>--constants</code> flag.</p>
<p>If a harness requires more constants than supplied extraction will fail.</p>
<h2 id="output-directory-structure"><a class="header" href="#output-directory-structure">Output directory structure</a></h2>
<p>The output directory can be selected with the <code>-o</code> flag and if the flag is omitted <code>picus_files</code> is used as a default.
The tool writes into this directory one Picus file per extracted harness. These files are organized hierarchically
by <em>instruction</em>, <em>name</em>, <em>chip</em>, and <em>type</em>. For example the harnesses for <code>equality</code> in the <code>native</code> chip will produce
the following structure.</p>
<pre><code>└── picus_files
    └── equality
        ├── is_equal_to
        │   └── native
        │       ├── bit
        │       │   └── output.picus
        │       └── native
        │           └── output.picus
        └── is_equal_to_fixed
            └── native
                ├── bit
                │   └── output.picus
                └── native
                    └── output.picus
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="audithub"><a class="header" href="#audithub">AuditHub</a></h1>
<p>AuditHub is a Veridise service where users can run verification tools such as Picus.
Is accesible via both its web interface and CLI. In this document we will explain
how to prepare a project for AuditHub, how to configure the CLI, and how to use it for
interacting with AuditHub.</p>
<h2 id="audithub-cli"><a class="header" href="#audithub-cli">AuditHub CLI</a></h2>
<p>The CLI is a Python 3 program that can be installed with pip (<code>pip install audithub-client</code>).</p>
<p>The CLI needs to be configured before using it. For that go to Account Settings / API Keys in
AuditHub’s UI. Store the given client id and client secret somewhere secure
depending on the intended usage of the keys.</p>
<p><img src="images/api-key.png" alt="API Key generation dialog"></p>
<p>For using the keys locally it could be a <code>.envrc</code> file
managed by <a href="https://direnv.net">direnv</a>. For using them in CI that could be Github Secrets accesible
by Github Actions.</p>
<p>Once the keys are ready check the <a href="https://pypi.org/project/audithub-client/">CLI’s documentation</a> on how to
configure you system such that the CLI can use them to connect to AuditHub.</p>
<p>You can confirm that the CLI is working correctly by running the following</p>
<pre><code>$ ah get-my-profile
{"id": "...", "name": "&lt;Your name&gt;", "email": "&lt;Your email&gt;", "rights": [...], ...}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="creating-a-new-project"><a class="header" href="#creating-a-new-project">Creating a new project</a></h1>
<p>Before being able to upload new versions to AuditHub and launch jobs from the CLI it is necessary to create a project
from the UI.</p>
<p>For the first version of the project generate <em>at least some</em> Picus files with <code>midnight-extractor</code> and pack them into a ZIP file.</p>
<pre><code class="language-bash"># For example, generate some Picus files for the equality instructions
cargo run --release -- --chip native --type native equality
zip -r picus_files.zip picus_files
</code></pre>
<p>Then go to AuditHub’s UI and into the organization where you want to create the project and click in Create New Project</p>
<p><img src="images/new-project/001.png" alt="Organization dashboard"></p>
<p>Given a name to the project and click Next.</p>
<p><img src="images/new-project/002.png" alt="Project Name"></p>
<p>Select the File option and locate the ZIP file prepared earlier. Once you have it click Next.</p>
<p><img src="images/new-project/003.png" alt="Source Location"></p>
<p>Select Archive root and click Next.</p>
<p><img src="images/new-project/004.png" alt="Project Root"></p>
<p>In this section, leave this options as they are and click Next.</p>
<p><img src="images/new-project/005.png" alt="Project Paths"></p>
<p>Select Picus files (and optionally LLZK files) and click Next.</p>
<p><img src="images/new-project/006.png" alt="Project Contents"></p>
<p>Leave the next two sections untouched and just click Next.</p>
<p><img src="images/new-project/007.png" alt="Dependencies"></p>
<p><img src="images/new-project/008.png" alt="Build"></p>
<p>Check that everything looks right and click Submit.</p>
<p><img src="images/new-project/009.png" alt="Review"></p>
<p>Once the project has been created you will be able to access its main view. For interacting with this
project from the CLI you need to pass the organization and project IDs. Note in the part of the URL
<code>organizations/&lt;number&gt;/projects/&lt;number&gt;</code>. The first is the organization ID and the second the project ID.</p>
<p><img src="images/new-project/010.png" alt="Project view"></p>
<p>These IDs can be configured as environment variables and the CLI will use them while executing.</p>
<pre><code>export AUDITHUB_ORGANIZATION_ID=&lt;organization id&gt;
export AUDITHUB_PROJECT_ID=&lt;project id&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="uploading-new-versions"><a class="header" href="#uploading-new-versions">Uploading new versions</a></h1>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="launching-jobs"><a class="header" href="#launching-jobs">Launching jobs</a></h1>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="writing-new-harnesses"><a class="header" href="#writing-new-harnesses">Writing new harnesses</a></h1>
<p>Adding more harnesses is done in the <code>crates/harnesses</code> crate. The crate is organized by instructions and,
in some cases, by chips or gadgets that implement the instructions.</p>
<p>Conceptually, a harness is a function that receives a <em>chip</em>, a <em>layouter</em>, some inputs and returns a <code>Result</code>.
In reallity a harness is a function with a more abstract signature but that complexity is usually managed by a macro
that allows for a more declarative approach. However, if the macro is not an option see the section below
on how to write harnesses from scratch.</p>
<h2 id="writing-declarative-harnesses"><a class="header" href="#writing-declarative-harnesses">Writing declarative harnesses</a></h2>
<p>A harnesses written declaratively has the following structure.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// The harnesses are NOT parametrized by a field.
use mdnt_extractor_core::fields::Blstrs as F;

// Sets the harness name of the function below.
#[entry("control-flow/select/native/native")]
// Marks the function as a harness
#[harness]
pub fn select_native(
    // The first argument is the chip. The only requirement is that the type is a &amp;-reference.
    chip: &amp;NativeChip&lt;F&gt;,
    // The second argument is the layouter. The actual layouter variable is not a 
    // `impl Layouter&lt;F&gt;`. This is syntactic sugar for a namesake variable that 
    // implements `midnight_proofs::circuit::Layouter`. So the result is the same.
    layouter: &amp;mut impl Layouter&lt;F&gt;,
    // The third argument are the inputs. The type of the input must implement `LoadFromCells`.
    (cond, a, b): (AssignedBit&lt;F&gt;, AssignedNative&lt;F&gt;, AssignedNative&lt;F&gt;),
    // Optional fourth argument that allows injecting additional IR for aiding verification.
    injected_ir: &amp;mut InjectedIR&lt;RegionIndex, Expression&lt;F&gt;&gt;
    // The output must be a Result&lt;T, E&gt; where T is a type that implements `StoreIntoCells` and 
    // E is `midnight_proofs::plonk::Error`.
) -&gt; Result&lt;AssignedNative&lt;F&gt;, Error&gt; {
    // Runs the target method.
    chip.select(layouter, &amp;cond, &amp;a, &amp;b)
}
<span class="boring">}</span></code></pre>
<p>And that’s it. The list of harnesses is defined automatically at compile time and
can be obtained by calling the <code>mdnt_harnesses::harnesses</code> function.
The extractor uses that function for selecting what harnesses need to be extracted.</p>
<p>The macros do a lot of heavy lifting in converting this form to how the harnesses look internally.
The <code>#[entry("...")]</code> macro registers the function in the list of harnesses. This registration is accomplised
with <code>mdnt_extractor_core::entry!</code> and in some cases is actually better to use this macro instead of <code>#[entry]</code>.
For example, a harness that is parametrized by a constant parameter for selecting the size of some arrays.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>entry!("bar/example_10/foo/native", example::&lt;10&gt;);
entry!("bar/example_20/foo/native", example::&lt;20&gt;);
#[harness]
pub fn example&lt;const N: usize&gt;(
    chip: &amp;FooChip&lt;F&gt;,
    layouter: &amp;mut impl Layouter&lt;F&gt;,
    arr: [AssignedNative&lt;F&gt;; N]
) -&gt; Result&lt;AssignedNative&lt;F&gt;, Error&gt; {
    chip.foo(layouter, &amp;arr)
}
<span class="boring">}</span></code></pre>
<p>The harness macro family has 6 macros that can be used for declaring harnesses and offer some flexibility for covering most cases.</p>
<p>For most chips (the ones where <code>ChipArgs::Args == ()</code>) use the macros <code>harness</code>, <code>harness_mut</code>, and <code>unit_harness</code>. The
first macro is the one we saw above already. <code>harness_mut</code> is similar to <code>harness</code> but the first argument (the <em>chip</em> argument)
must be a <code>&amp;mut</code>-reference instead. <code>unit_harness</code> is for methods that do have a return value (<code>Result&lt;(),Error&gt;</code>). For this
macro split the inputs of the function into two sets and pass them as the 3rd and 4th argument. The 4th argument can be
considered the <em>output</em> and additional constraints can be injected for aiding Picus with verification. That argument, however,
is not encoded as a Picus output. Is just a separation for readability. In these cases a vacuous output is generated
that is constrained to be equal to 0.</p>
<p>If for the target chip <code>ChipArgs::Args != ()</code> then you need to use <code>harness_with_args</code>, <code>harness_with_args_mut</code>, and
<code>unit_harness_with_args</code>. These macros work identically to their counterparts but require declaring the type of
<code>ChipArgs::Args</code> (i.e. <code>#[harness_with_args(usize)]</code>). For providing the argument you need to define a function that has
the same name as the harness function followed by <code>_args</code> (i.e. <code>foo</code> would be <code>foo_args</code>). That function cannot take any
arguments and return a value of the declared type.</p>
<p>Since the most common argument type is <code>usize</code> we include a convenience macro <code>#[usize_args(&lt;usize&gt;)]</code> that automatically creates
the function with the correct name and returns the value passed as argument to the macro.</p>
<p>All the macros accept an optional argument with an expression containing <code>LookupCallbacks</code>. For example, for extracting a
harness like the first one but for <code>NativeGadget</code> instead we need to handle the range lookup that gadget uses. For that we can
do as follows:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[entry("control-flow/select/native-gadget/native")]
// The range_lookup function creates the appropiate handler for the lookup.
#[harness(range_lookup(8))]
pub fn select_native(
    chip: &amp;NG&lt;F&gt;,
    layouter: &amp;mut impl Layouter&lt;F&gt;,
    (cond, a, b): (AssignedBit&lt;F&gt;, AssignedNative&lt;F&gt;, AssignedNative&lt;F&gt;),
) -&gt; Result&lt;AssignedNative&lt;F&gt;, Error&gt; {
    chip.select(layouter, &amp;cond, &amp;a, &amp;b)
}
<span class="boring">}</span></code></pre>
<h2 id="writing-harnesses-from-scratch-wip"><a class="header" href="#writing-harnesses-from-scratch-wip">Writing harnesses from scratch (WIP)</a></h2>
<p>If the macros shown above don’t fit the needs of this new harness they can still be defined by hand. Below is an annotated
version of the kind of code the macros generate that can serve as a starting point for creating a harness from scratch.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>entry!("control-flow/select/native-gadget/native", select_native);
fn select_native(ctx: &amp;Ctx) -&gt; anyhow::Result&lt;Output&gt; {
    // The actual logic of the harness needs to be wrapped into a trait.
    // So we need to create a type for that.
    struct Circuit&lt;'s, 'c&gt;(PhantomData&lt;(&amp;'s (), &amp;'c ())&gt;);

    // This trait defines the types that the harness uses. 
    // The extractor will rely on this trait for finding the right types for 
    // creating the right final circuit.
    impl&lt;'s, 'c&gt; AbstractCircuitIO for Circuit&lt;'s, 'c&gt; {
        // The chip type. It must implement CircuitInitialization but is not enforced.
        type Chip = NativeChip&lt;F&gt;;

        // The type of the inputs. Must implement `LoadFromCells` and if the method takes several 
        // they can be grouped in tuples up to 12 elements.
        type Input = (AssignedBit&lt;F&gt;, AssignedNative&lt;F&gt;, AssignedNative&lt;F&gt;);

        // The type of the outputs. Same as the inputs but must implement the 
        // `StoreIntoCells` trait instead.
        type Output = AssignedNative&lt;F&gt;;

        // These two types need to be the same as their namesakes in CircuitInitialization.
        type Config = &lt;NativeChip&lt;F&gt; as CircuitInitialization&lt;ExtractionLayouter&lt;'s, 'c, F&gt;&gt;&gt;::Config;

        type ConfigCols =
            &lt;NativeChip&lt;F&gt; as CircuitInitialization&lt;ExtractionLayouter&lt;'s, 'c, F&gt;&gt;&gt;::ConfigCols;
    }

    // The actual logic is defined with this trait.
    // `harness_mut` will use `AbstractCircuitMut`
    impl AbstractCircuit&lt;F&gt; for Circuit&lt;'_, '_&gt; {
        fn synthesize&lt;L&gt;(
            &amp;self,
            chip: &amp;Self::Chip,
            layouter: &amp;mut L,
            (cond, a, b): Self::Input,
            _: &amp;mut InjectedIR&lt;
                RegionIndex,
                Expression&lt;F&gt;,
            &gt;,
        ) -&gt; anyhow::Result&lt;Self::Output, Error&gt;
        where
            L: Layouter&lt;F&gt;,
        {
            chip.select(layouter, &amp;cond, &amp;a, &amp;b)
        }
    }

    // If the chip arguments is () then this trait can be used.
    impl NoChipArgs for Circuit&lt;'_, '_&gt; {}

    // The type we created and implemented the types for can be passed to this 
    // type. This type handles the linking between the inputs, outputs, and the harness logic.
    let ci: CircuitImpl&lt;'_, F, Circuit, Function&gt; =
        CircuitImpl::new(ctx, Circuit(Default::default()));
    // The first argument of this method is a type that implements the  
    // CircuitSynthesis trait, which is Haloumi's counterpart to the Circuit trait in Halo2.
    // As long as the value passed there meets the interface all the stuff above this line is not 
    // mandatory.
    // The second argument is an optional dyn reference to a LookupCallbacks implementation.
    // These callbacks are invoked when the circuit has lookups for getting the IR that needs to be 
    // generated for handling the lookup.
    ctx.lower_circuit(ci, None)
}

<span class="boring">}</span></code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="supporting-new-chips"><a class="header" href="#supporting-new-chips">Supporting new chips</a></h1>
<p>TBD</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="supporting-new-assigned-types"><a class="header" href="#supporting-new-assigned-types">Supporting new assigned types</a></h1>
<p>TBD</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
